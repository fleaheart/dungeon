<!doctype html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>マップ</title>

    <style type="text/css">
      canvas { border: 1px solid black; }

    .map {
        border: solid 2px black;
        padding: 0px;
        background-color: lightgrey;
        vertical-align: top;

    }

    .kukaku {
        display: inline-block;
        padding: 0px;
        margin: 0px;
        width: 40px;
        height: 40px;
        background-color: white;
        vertical-align: top;
        text-align: center;
    }

    .box0, .box1, .box2, .box3, .box4, .box5, .box6, .box7,
    .box8, .box9, .boxA, .boxB, .boxC, .boxD, .boxE, .boxF {
        display: inline-block;
        margin: 0px;
        padding: 0px;
        width: 36px;
        height: 36px;
        vertical-align: middle;
        text-align: center;
        border : solid 0px black;
        background-color: white;
    }

    .box0 {
        margin: 2px 2px 2px 2px;
        border-width: 0px 0px 0px 0px;
    }
    .box1 {
        margin: 0px 2px 2px 2px;
        border-width: 2px 0px 0px 0px;
    }
    .box2 {
        margin: 2px 0px 2px 2px;
        border-width: 0px 2px 0px 0px;
    }
    .box3 {
        margin: 0px 0px 2px 2px;
        border-width: 2px 2px 0px 0px;
    }
    .box4 {
        margin: 2px 2px 0px 2px;
        border-width: 0px 0px 2px 0px;
    }
    .box5 {
        margin: 0px 2px 0px 2px;
        border-width: 2px 0px 2px 0px;
    }
    .box6 {
        margin: 2px 0px 0px 2px;
        border-width: 0px 2px 2px 0px;
    }
    .box7 {
        margin: 0px 0px 0px 2px;
        border-width: 2px 2px 2px 0px;
    }
    .box8 {
        margin: 2px 2px 2px 0px;
        border-width: 0px 0px 0px 2px;
    }
    .box9 {
        margin: 0px 2px 2px 0px;
        border-width: 2px 0px 0px 2px;
    }
    .boxA {
        margin: 2px 0px 2px 0px;
        border-width: 0px 2px 0px 2px;
    }
    .boxB {
        margin: 0px 0px 2px 0px;
        border-width: 2px 2px 0px 2px;
    }
    .boxC {
        margin: 2px 2px 0px 0px;
        border-width: 0px 0px 2px 2px;
    }
    .boxD {
        margin: 0px 2px 0px 0px;
        border-width: 2px 0px 2px 2px;
    }
    .boxE {
        margin: 2px 0px 0px 0px;
        border-width: 0px 2px 2px 2px;
    }
    .boxF {
        margin: 0px 0px 0px 0px;
        border-width: 2px 2px 2px 2px;
    }

    .nakami {
        display: table-cell;
        width: 36px;
        height: 36px;
        text-align: center;
        vertical-align: middle;
    }

    </style>

    <script type="text/javascript">
        /*
        * 俺ルール：グローバル変数には先頭に$をつける
        */
        var $pc = new Object(), $mapdata,
        $kabex, $kabey, $kabe2x, $kabe2y, $SCREEN_WIDTH, $SCREEN_HEIGHT, $HIDARI, $MIGI;

            $mapdata = ['95555513',
            'A95553AA',
            'AAD53AAA',
            'AC556AAA',
            'C5515406',
            '93FAD3AB',
            'AAD452AA',
            'EC5556C6'];

        $kabex = [ 5, 40, 114, 155, 180 ];
        $kabey = [ 5, 31, 85, 115, 134 ];

        $kabe2x = [ 5, 20, 114, 160, 180 ];
        $kabe2y = [ 5, 16, 85, 120, 140 ];

        $SCREEN_WIDTH = 400 - $kabex[0] - $kabex[0];
        $SCREEN_HEIGHT = 300 - $kabey[0] - $kabey[0];

        $HIDARI = 'hidari';
        $MIGI = 'migi';
        
        /**
         * 最初に実行されるもの
         */
        window.addEventListener('load', function() {
            var div_map;

            document.addEventListener('keydown', keyDownEvent);

            div_map = document.getElementById('div_map');

            mapview(div_map, $mapdata);

            $pc.xpos = 0;
            $pc.ypos = 7;
            $pc.muki = 0;

            document.getElementById('nakami[' + $pc.xpos + '][' + $pc.ypos + ']').innerHTML = '↑';

            submapview();
        });

        function keyDownEvent(evt) {
            var keyCode, mukiArray, mukiArrayLengt, map, kabeChar, kabeType, xdiff, ydiff;

            keyCode = evt.keyCode;
            
            mukiArray = ['↑','→','↓','←'];
            mukiArrayLength = mukiArray.length;

            if (keyCode == '87') {
                map = document.getElementById('map[' + $pc.xpos + '][' + $pc.ypos + ']');
                kabeChar = map.className.replace(/box/, '');
                kabeType = parseInt(kabeChar, 16);

                xdiff = 0;
                ydiff = 0;
                if ($pc.muki == 0) {
                    if ((kabeType & 1) == 0) {
                        ydiff = -1;
                    }
                } else if ($pc.muki == 1) {
                    if ((kabeType & 2) == 0) {
                        xdiff = +1;
                    }
                } else if ($pc.muki == 2) {
                    if ((kabeType & 4) == 0) {
                        ydiff = +1;
                    }
                } else if ($pc.muki == 3) {
                    if ((kabeType & 8) == 0) {
                        xdiff = -1;
                    }
                }

                if (xdiff != 0 || ydiff != 0) {
                    document.getElementById('nakami[' + $pc.xpos + '][' + $pc.ypos + ']').innerHTML = '';
                    $pc.xpos += xdiff;
                    $pc.ypos += ydiff;
                    document.getElementById('nakami[' + $pc.xpos + '][' + $pc.ypos + ']').innerHTML = mukiArray[$pc.muki];

                    submapview();
                }

            } else if (keyCode == '65') {
                $pc.muki--;
                if ($pc.muki < 0) {
                    $pc.muki = mukiArrayLength - 1;
                }
                document.getElementById('nakami[' + $pc.xpos + '][' + $pc.ypos + ']').innerHTML = mukiArray[$pc.muki];

                submapview();

            } else if (keyCode == '68') {
                $pc.muki++;
                if (mukiArrayLength - 1 < $pc.muki) {
                    $pc.muki = 0;
                }
                document.getElementById('nakami[' + $pc.xpos + '][' + $pc.ypos + ']').innerHTML = mukiArray[$pc.muki];

                submapview();
            }

        }

        function submapview() {
            var div_submap, x, y, kukaku, map, br, xstart, xend, xzoubun, ystart, yend, yzoubun, genshidata, line, chukandata, submapdata,
            c, n,
            /*
             * 切り取る範囲 左側右側は、真ん中を除いた数
             * 0093F は、00:hidarigawa、3F:migigawa、9:真ん中
             */
            zenpou = 3, hidarigawa = 2, migigawa = 2;



            div_submap = document.getElementById('div_submap');
            div_submap.innerHTML = '';

            genshidata = new Array();
            if ($pc.muki == 0) {
                for (y = zenpou * -1; y <= 0; y++) {
                    line = '';
                    for (x = hidarigawa * -1; x <= migigawa; x++) {
                        c = getPosChar($mapdata, $pc.xpos + x, $pc.ypos + y);
                        line += c;
                    }
                    genshidata.push(line);
                }

            } else if ($pc.muki == 1) {
                for (x = zenpou; 0 <= x; x--) {
                    line = '';
                    for (y = hidarigawa * -1; y <= migigawa; y++) {
                        c = getPosChar($mapdata, $pc.xpos + x, $pc.ypos + y);
                        n = parseInt(c, 16);
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        c = n.toString(16).toUpperCase();
                        line += c;
                    }
                    genshidata.push(line);
                }

            } else if ($pc.muki == 2) {
                for (y = zenpou; 0 <= y; y--) {
                    line = '';
                    for (x = hidarigawa; migigawa * -1 <= x; x--) {
                        c = getPosChar($mapdata, $pc.xpos + x, $pc.ypos + y);
                        n = parseInt(c, 16);
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        c = n.toString(16).toUpperCase();
                        line += c;
                    }
                    genshidata.push(line);
                }

            } else if ($pc.muki == 3) {
                for (x = zenpou * -1; x <= 0; x++) {
                    line = '';
                    for (y = hidarigawa; migigawa * -1 <= y; y--) {
                        c = getPosChar($mapdata, $pc.xpos + x, $pc.ypos + y);
                        n = parseInt(c, 16);
                        n = n * 2;
                        if (16 <= n) {
                            n = n - 16;
                            n = n + 1;
                        }
                        c = n.toString(16).toUpperCase();
                        line += c;
                    }
                    genshidata.push(line);
                }

            }

            mapview(div_submap, genshidata);

            var html = div_submap.innerHTML;
            html = html + genshidata[0] + '<br>' + genshidata[1] + '<br>' + genshidata[2] + '<br>' + genshidata[3] + '<br>';
            div_submap.innerHTML = html;

    var cvs, context;
    cvs = document.getElementById('map3d');

    context = cvs.getContext('2d');

    context.beginPath();
    context.clearRect(0, 0, 400, 300);

    var kabe = -1;

            for (var i = 0; i <= zenpou; i++) {
                c = genshidata[zenpou - i].charAt(hidarigawa);
                n = parseInt(c, 16);

                var hidarikabeflg = 0;
                var migikabeflg = 0;

                if ((n & 1) == 1) {
                    if (kabe == -1 || i < kabe) {
                        kabemaekaku(context, i + 1);
                        kabe = i;
                    }
                }
                if ((n & 8) == 8) {
                    if (kabe == -1 || i <= kabe) {
                        kabetatekaku(context, i + 1, $HIDARI);
                        hidarikabeflg = 1;
                    }
                }
                if ((n & 2) == 2) {
                    if (kabe == -1 || i <= kabe) {
                        kabetatekaku(context, i + 1, $MIGI);
                        migikabeflg = 1;
                    }
                }

                var c = genshidata[zenpou - i].charAt(hidarigawa - 1);
                n = parseInt(c, 16);
                if ((n & 1) == 1) {
                    if (kabe == -1 || i <= kabe) {
                        if (hidarikabeflg != 1) {
                            $kabeyokokaku(context, i + 1, $HIDARI);
                        }
                    }
                }

                var c = genshidata[zenpou - i].charAt(hidarigawa + 1);
                n = parseInt(c, 16);
                if ((n & 1) == 1) {
                    if (kabe == -1 || i <= kabe) {
                        if (migikabeflg != 1) {
                            kabeyokokaku(context, i + 1, $MIGI);
                        }
                    }
                }
            }
        }

        function getPosChar(mapdata, x, y) {
            var c;
            if (y < 0 || mapdata.length <= y) {
                c = '0';
            } else {
                if (x < 0 || mapdata[y].length <= x) {
                    c = '0';
                } else {
                    c = mapdata[y].charAt(x);
                }
            }
            return c;
        }

        function mapview(div_map, kakumapdata) {
            var x, xl, y, yl, c, kukaku, map, makami, br;

            for (y = 0, yl = kakumapdata.length; y < yl; y++) {
                for (x = 0, xl = kakumapdata[y].length; x < xl; x++) {
                    c = kakumapdata[y].charAt(x);

                    kukaku = document.createElement('DIV');
                    kukaku.className = 'kukaku';

                    map = document.createElement('DIV');
                    map.id = 'map[' + x + '][' + y + ']';
                    map.className = 'box' + c;

                    nakami = document.createElement('DIV');
                    nakami.id = 'nakami[' + x + '][' + y + ']';
                    nakami.className = 'nakami';

                    map.appendChild(nakami);
                    kukaku.appendChild(map);
                    div_map.appendChild(kukaku);
                    
                }

                br = document.createElement('BR');
                div_map.appendChild(br);
            }
        }

        function kabemaekaku(context, fukasa) {
            var startx, fugou;

            context.beginPath();

            context.moveTo($kabex[fukasa], $kabey[fukasa]);
            context.lineTo($SCREEN_WIDTH - $kabex[fukasa], $kabey[fukasa]);
            context.lineTo($SCREEN_WIDTH - $kabex[fukasa], $SCREEN_HEIGHT - $kabey[fukasa]);
            context.lineTo($kabex[fukasa], $SCREEN_HEIGHT - $kabey[fukasa]);

            context.closePath();
            context.stroke();
        }

        function kabetatekaku(context, fukasa, side) {
            var startx, fugou;

            if (side == $HIDARI) {
                startx = 0;
                fugou = 1;
            }
            if (side == $MIGI) {
                startx = $SCREEN_WIDTH;
                fugou = -1;
            }

            context.beginPath();

            context.moveTo(startx + fugou * $kabex[fukasa - 1], $kabey[fukasa - 1]);
            context.lineTo(startx + fugou * $kabex[fukasa], $kabey[fukasa]);
            context.lineTo(startx + fugou * $kabex[fukasa], $SCREEN_HEIGHT - $kabey[fukasa]);
            context.lineTo(startx + fugou * $kabex[fukasa - 1], $SCREEN_HEIGHT - $kabey[fukasa - 1]);

            context.closePath();
            context.stroke();
        }

        function kabeyokokaku(context, fukasa, side) {
            var startx, fugou;

            if (side == $HIDARI) {
                startx = 0;
                fugou = 1;
            }
            if (side == $MIGI) {
                startx = $SCREEN_WIDTH;
                fugou = -1;
            }

            context.beginPath();

            context.moveTo(startx + fugou * $kabex[fukasa - 1], $kabey[fukasa]);  
            context.lineTo(startx + fugou * $kabex[fukasa], $kabey[fukasa]);  
            context.lineTo(startx + fugou * $kabex[fukasa], $SCREEN_HEIGHT - $kabey[fukasa]);  
            context.lineTo(startx + fugou * $kabex[fukasa - 1], $SCREEN_HEIGHT - $kabey[fukasa]);  

            context.closePath();
            context.stroke();
        }

    </script>
</head>

<body>
    <div id="div_map" class="map">
    </div>
    <br>

    <canvas id="map3d" width="400" height="300" style="position:absolute; top:20px; left:340px;"></canvas>

    <div id="div_submap" class="map" style="display:nonex; position:absolute; top:20px; left:680px;">
    </div>

</body>

</html>